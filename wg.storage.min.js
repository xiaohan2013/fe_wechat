! function() {
	function a() {
		d.check(function(a, c) {
			var d = document.createElement("div"),
				e = Math.floor(a / 60);
			d.innerHTML = '<span class="wx_history_close" id="wx_history_close" ptag="37075.2.3">关闭</span><a ptag="37075.2.2" href="' + c.url + '" ><strong>' + (e > 0 ? e + "分钟前" : "刚刚") + "您在浏览：</strong><p>" + b(c.title.replace("搜索到", "")) + "</p></a>", d.className = "wx_history", document.body.appendChild(d);
			try {
				ECC.cloud.report.trace({
					ptag: "37075.2.1"
				})
			} catch (f) {}
			var g = document.getElementById("wx_history_close");
			g.addEventListener("click", function() {
				d.style.display = "none"
			}), setTimeout(function() {
				d.style.display = "none"
			}, 5e3)
		})
	}

	function b(a) {
		return "string" != typeof a ? "" : a.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/\'/g, "&apos;").replace(/ /g, "&nbsp;")
	}
	var c = navigator.userAgent,
		d = {
			sProxyUrl: "http://wqs.jd.com/portal/wx/storageBridge.shtml",
			sDomain: "wqs.jd.com",
			sCacheKey: "jdHistory",
			oItemStruct: {
				type: "1",
				key: "",
				url: "",
				title: "",
				desc: "",
				img: "",
				time: ""
			},
			isAnroid: c.match(/(Android);?[\s\/]+([\d.]+)?/),
			oCallbacks: {},
			bIsInitMsg: !1,
			postMessage: function(a, b, c) {
				var d, e = this,
					f = "cacheProxyIfr",
					g = {};
				g.cacheData = b, g.cacheKey = this.sCacheKey, g.msgType = a, !this.oCallbacks[a] && (this.oCallbacks[a] = []), c && this.oCallbacks[a].push(c), 2 == this.bIsInitMsg ? (d = document.getElementById(f), d.contentWindow.postMessage(JSON.stringify(g), "http://" + e.sDomain)) : this.bIsInitMsg || (this.bIsInitMsg = 1, d = document.createElement("IFRAME"), d.id = "cacheProxyIfr", d.src = this.sProxyUrl, d.style.cssText = "height:0px;width:0px;visibility:hidden", document.body.appendChild(d), d.onload = function() {
					e.bIsInitMsg = 2, d.contentWindow.postMessage(JSON.stringify(g), "http://" + e.sDomain)
				}, window.addEventListener("message", function(a) {
					try {
						if (a.origin != "http://" + e.sDomain) return;
						var b = JSON.parse(a.data),
							c = b.msgType,
							d = e.oCallbacks[c];
						if (d) {
							e.oCallbacks[c] = [];
							for (var f = 0; f < d.length; f++) d[f].call(e, b.cacheData || {
								update: 1
							})
						}
					} catch (g) {}
				}))
			},
			get: function(a, b) {
				var c = this;
				if (location.host !== this.sDomain) this.postMessage("get", null, b);
				else if (window.localStorage) try {
					var d = JSON.parse(localStorage.getItem(a) || (c.isAnroid ? c.getCookie(a) : "null"));
					d || (d = {
						update: 1
					}), b && b.call(c, d)
				} catch (e) {
					localStorage.removeItem(a)
				}
				return this
			},
			set: function(a) {
				var b = (new Date).getTime(),
					c = this;
				return this.get(this.sCacheKey, function(e) {
					var f = e.arrHisData;
					f || (f = []), a.time = b;
					for (var g in d.oItemStruct) a[g] || (a[g] = d.oItemStruct[g]);
					for (var h = 0; h < f.length; h++) {
						var i = f[h];
						if (a.key === i.key) return a.url || (a.url = a.key), f[h] = a, e.arrHisData = f, d.writeHistory(e, 1), c
					}
					a.url || (a.url = a.key), f.unshift(a), e.arrHisData = f, d.writeHistory(e, 1)
				}), this
			},
			writeHistory: function(a, b, c) {
				var e = {};
				try {
					if (!a.arrHisData && (a.arrHisData = []), a.arrHisData.sort(function(a, b) {
							return a.time > b.time ? -1 : a.time < b.time ? 1 : 0
						}), a.arrHisData = a.arrHisData.slice(0, window.storageHistoryRecordMaxNum || 20), a.update = b || 0, this.isAnroid) {
						for (var f in a) e[f] = a[f];
						e.arrHisData = e.arrHisData.slice(0, 2), this.setCookie(this.sCacheKey, "", -1, "", "jd.com")
					}
					location.host !== this.sDomain ? this.postMessage("set", a, c) : window.localStorage && (localStorage.setItem(d.sCacheKey, JSON.stringify(a)), c && c.call(this))
				} catch (g) {}
				return this
			},
			check: function(a) {
				this.setCookie(this.sCacheKey, "", -1, "", "jd.com");
				var b = (new Date).getTime(),
					c = 600,
					e = "undefined" != typeof JD && JD.url.getUrlParam("isappinstalled") || "",
					f = this;
				this.get(this.sCacheKey, function(g) {
					try {
						var h = g.arrHisData;
						if (location.href.indexOf("ptype=") > -1 && 1 === history.length && h && h.length > 0 && 0 != g.update && 1 != window.hideHis && !e) {
							var i = h[0],
								j = i.time,
								k = (b - j) / 1e3;
							c > k && a && a.call(f, k, i)
						}
					} catch (l) {}
					return 0 != g.update ? d.writeHistory(g, 0, function() {
						d.ready()
					}) : d.ready(), this
				})
			},
			ready: function() {
				window.wgStorage = d, window.wgStorageReady && window.wgStorageReady(d)
			},
			getCookie: function(a) {
				var b = new RegExp("(^| )" + a + "(?:=([^;]*))?(;|$)"),
					c = document.cookie.match(b);
				return c ? c[2] ? unescape(c[2]) : "" : null
			},
			setCookie: function(a, b, c, d, e, f) {
				var g = new Date,
					c = arguments[2] || null,
					d = arguments[3] || "/",
					e = arguments[4] || null,
					f = arguments[5] || !1;
				c ? g.setMinutes(g.getMinutes() + parseInt(c)) : "", document.cookie = a + "=" + escape(b) + (c ? ";expires=" + g.toGMTString() : "") + (d ? ";path=" + d : "") + (e ? ";domain=" + e : "") + (f ? ";secure" : "")
			}
		};
	a()
}();